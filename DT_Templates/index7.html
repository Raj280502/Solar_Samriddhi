<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Calculator - Select Your Roof</title>
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <style>
        body {
            background: var(--dark-bg);
        }
        .map-container {
            padding: 5rem 2rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .map-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .map-header h2 {
            font-family: var(--font-display);
            font-size: 1.75rem;
            color: var(--light-text);
            margin-bottom: 0.5rem;
        }
        .map-header p {
            color: var(--muted-text);
        }
        #map {
            height: 55vh;
            border-radius: var(--radius-xl);
            border: 2px solid var(--border-color);
            overflow: hidden;
        }
        .info-box {
            background: var(--dark-surface);
            padding: 1.5rem;
            border-radius: var(--radius-xl);
            margin-top: 1.5rem;
            border: 1px solid var(--border-color);
        }
        #area {
            font-size: 1.1rem;
            color: var(--light-text);
            text-align: center;
            padding: 1rem;
            background: var(--dark-card);
            border-radius: var(--radius-lg);
            margin-bottom: 1rem;
        }
        #area span {
            color: var(--primary);
            font-weight: 700;
        }
    </style>
</head>
<body>
    <header>
        <a href="/" class="logo">Solar Samriddhi</a>
    </header>

    <div class="map-container">
        <div class="map-header">
            <div class="progress-bar">
                <div class="step active">1</div>
                <div class="step active">2</div>
                <div class="step active">3</div>
                <div class="step active">4</div>
                <div class="step active">5</div>
                <div class="step">6</div>
            </div>
            <h2>üìç Select Your Roof Area</h2>
            <p>Use the drawing tools to outline your rooftop on the map</p>
        </div>
        
        <div id="map"></div>
        
        <div class="info-box">
            <div id="area">Draw on the map to calculate your roof area</div>
            <input type="hidden" id="area-field" value="">
            <input type="hidden" id="lat-field" value="">
            <input type="hidden" id="lng-field" value="">
            
            <div class="navigation-buttons">
                <a href="{% url 'index6' %}" class="prev-button">‚Üê Previous</a>
                <button type="button" id="next-btn" class="next-button" onclick="goToNext()">Next ‚Üí</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script>
        var map = L.map('map').setView([18.5204, 73.8567], 18);
        
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 20,
            attribution: '¬© Esri'
        }).addTo(map);
        
        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        
        var drawControl = new L.Control.Draw({
            edit: { featureGroup: drawnItems },
            draw: {
                polygon: { shapeOptions: { color: '#f59e0b', fillColor: '#f59e0b', fillOpacity: 0.3 }},
                rectangle: { shapeOptions: { color: '#f59e0b', fillColor: '#f59e0b', fillOpacity: 0.3 }},
                circle: false, circlemarker: false, marker: false, polyline: false
            }
        });
        map.addControl(drawControl);
        
        map.on(L.Draw.Event.CREATED, function(e) {
            drawnItems.clearLayers();
            var layer = e.layer;
            drawnItems.addLayer(layer);
            var area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
            var areaInSqM = Math.round(area * 100) / 100;
            document.getElementById('area').innerHTML = 'Roof Area: <span>' + areaInSqM + ' m¬≤</span>';
            document.getElementById('area-field').value = areaInSqM;
            
            // Get center coordinates of the drawn area
            var center = layer.getBounds().getCenter();
            document.getElementById('lat-field').value = center.lat.toFixed(6);
            document.getElementById('lng-field').value = center.lng.toFixed(6);
        });
        
        function goToNext() {
            var area = document.getElementById('area-field').value;
            var lat = document.getElementById('lat-field').value;
            var lng = document.getElementById('lng-field').value;
            
            if (!area || area === '') {
                alert('Please draw your roof area on the map first!');
                return;
            }
            
            // Navigate to index8 with the area and coordinates as URL parameters
            window.location.href = '/index8/?area=' + area + '&latitude=' + lat + '&longitude=' + lng;
        }
    </script>
</body>
</html>
